# C-73J 開放基板 仕様書

## 1. 基板概要

C-73Jの開放基板は、主に離床検知・頂点検知・減速機構作動（パラシュート開傘）を行う基盤である。

## 2. 機能一覧

- 他基板とのCAN通信
- モード管理機能
- センサーデータの取得
- センサーデータのmicroSDカードへの保存
- センサーデータを用いて
  - 機体の離床
  - 機体の頂点到達

  を検知し、減速機構を作動

## 3. シーケンス

### 3.1 モード概要

基板のモードは以下の通り。

1. Start\
  起動時のモード
2. Preparation\
  データロギング開始前のモード\
  本基板では
3. Logging\
  センサーデータの取得、microSDカードへの保存、離床検知・頂点検知・減速機構作動を行うモード

### 3.2 起動時（電源投入時）の処理

起動したら、

- センサー類の初期化
- microSDカードの初期化

を行う。

また、microSDカードから、前回の電源喪失時のモードを読み取り、以下のようにモード遷移する。

- 前回のモードを読み取れた場合：
  その読み取れたモードに遷移する
- 前回のモードを読み取れなかった場合：
  Startモードに遷移する

### 3.3 モード遷移のタイミグ

モード遷移は、通信基板からのCAN通信によるコマンドによってのみ行われる。

### 3.4 モード遷移時の処理

モード遷移が行われたら、すべてのモードで以下の処理が実行される。

- 遷移後のモードをmicroSDカードに保存

また、各モード固有の処理は以下の通りである。

#### 3.4.1 Start

- 本基板ではStartモード固有の処理はない

#### 3.4.2Preparation

- 本基板ではPreparationモード固有の処理はない

#### 3.4.3 Logging

- Loggignモードでは、離床/頂点検知プロセスを開始する

### 3.5 離床/頂点検知プロセスについて

離床/頂点検知プロセスでは、機体の離床検知・頂点検知・減速機構作動を行う。
このプロセスは以下のステップで実行される。

#### STEP1. 離床検知ステップ

このステップでは、センサーデータの取得、ロギング、離床検知を行う。

条件は以下の通り。

I. 6軸センサーから1000Hzで加速度を取得し、0.02秒ごと（20サンプル）の平均値を算出する。X軸、Y軸、Z軸それぞれの平均値を2乗して合計した値が4G2を50回（1秒間）連続して超えた場合\
II. 気圧センサーから25Hzで気圧を取得し、0.2秒ごと（5サンプル）の平均値を算出する。この平均値が前回の平均値より0.1 hPa以上低い状態が5回連続（1秒）した場合

2つのうち少なくとも一方が満たされた際、次のステップへ進む。

#### STEP2. 減速機構作動禁止ステップ

このステップでは、離床後エンジンの燃焼中に減速機構が作動することを防ぐため、10秒間待機し、次のステップへ進む。このステップの間、センサーデータのロギングは引き続き行う。

#### STEP3. 頂点検知ステップ

このステップでは、センサーデータの取得、ロギング、頂点検知を行う。

条件は以下の通り。

I. 離床時刻から19秒経過した場合（離床時刻は頂点検知をした時刻の1秒前）\
II. 気圧センサーから25Hzで気圧を取得し、0.2秒ごと（5サンプル）の平均値を算出する。この平均値が前回の平均値より高い状態が5回連続（1秒）した場合

2つのうち少なくとも一方が満たされたら直ちに減速機構を作動させ、次のステップへ進む。

#### STEP4. 減速機構作動後ステップ

このステップでは、センサーデータの取得とロギングを行う。

## 4. microSDカードへのデータ保存

microSDカードへのデータの保存は以下のようにする。

- config.json\
  基板の設定を書き込む\
  - サーボモータの角度（Open、Close）
  - モード
- data-{count}.csv\
  {count}には1からインクリメントされた数が入る\
  （例）data-1.csv, data-2.csv, ..., data-10.csv, ...
  